<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Руководство по data.table</title>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
  <meta name="description" content="Руководство по пакету data.table: перевод виньеток, справочная иформация.">
  <meta name="generator" content="bookdown 0.1.7 and GitBook 2.6.7">

  <meta property="og:title" content="Руководство по data.table" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Руководство по пакету data.table: перевод виньеток, справочная иформация." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Руководство по data.table" />
  
  <meta name="twitter:description" content="Руководство по пакету data.table: перевод виньеток, справочная иформация." />
  

<meta name="author" content="Андрей Огурцов">

<meta name="date" content="2016-09-12">


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="02_data.table_keys.html">
<link rel="next" href="04_data.table_reshaping.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>


  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html"><i class="fa fa-check"></i><b>1</b> Введение в data.table</a><ul>
<li class="chapter" data-level="1.1" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#ch1.1"><i class="fa fa-check"></i><b>1.1</b> Анализ данных с data.table</a></li>
<li class="chapter" data-level="1.2" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#ch1.2"><i class="fa fa-check"></i><b>1.2</b> Данные</a></li>
<li class="chapter" data-level="1.3" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#ch1.3"><i class="fa fa-check"></i><b>1.3</b> Введение</a></li>
<li class="chapter" data-level="1.4" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#ch1.4"><i class="fa fa-check"></i><b>1.4</b> 1. Основы</a><ul>
<li class="chapter" data-level="1.4.1" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#ch1.4.1"><i class="fa fa-check"></i><b>1.4.1</b> a) Что такое <em>data.table</em>?</a></li>
<li class="chapter" data-level="1.4.2" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#ch1.4.2"><i class="fa fa-check"></i><b>1.4.2</b> b) Общий вид - каким образом реализованы улучшения <em>data.table</em>?</a></li>
<li class="chapter" data-level="1.4.3" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#c----i"><i class="fa fa-check"></i><b>1.4.3</b> c) Выбор строк в <code id="ch1.4.3">i</code></a></li>
<li class="chapter" data-level="1.4.4" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#d----j"><i class="fa fa-check"></i><b>1.4.4</b> d) Выбор столбцов в <code id="ch1.4.4">j</code></a></li>
<li class="chapter" data-level="1.4.5" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#e-----j"><i class="fa fa-check"></i><b>1.4.5</b> e) Вычислить или <em>выполнить</em> в <code id="ch1.4.5">j</code></a></li>
<li class="chapter" data-level="1.4.6" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#f---i----j"><i class="fa fa-check"></i><b>1.4.6</b> f) Выбрать в <code>i</code> <em>и</em> выполнить в <code id="ch1.4.6">j</code></a></li>
<li class="chapter" data-level="1.4.7" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#g------------j---data.frame"><i class="fa fa-check"></i><b>1.4.7</b> g) Отлично! Но как я могу ссылаться на столбцы по именам в <code>j</code> (как в <em>data.frame</em>)?</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#section-1.5"><i class="fa fa-check"></i><b>1.5</b> 2. Агрегирования</a><ul>
<li class="chapter" data-level="1.5.1" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#a----by"><i class="fa fa-check"></i><b>1.5.1</b> a) Группировка с использованием <code>by</code></a></li>
<li class="chapter" data-level="1.5.2" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#b-keyby"><i class="fa fa-check"></i><b>1.5.2</b> b) keyby</a></li>
<li class="chapter" data-level="1.5.3" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#c-"><i class="fa fa-check"></i><b>1.5.3</b> c) Цепочки</a></li>
<li class="chapter" data-level="1.5.4" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#d---by"><i class="fa fa-check"></i><b>1.5.4</b> d) Выражения в <code>by</code></a></li>
<li class="chapter" data-level="1.5.5" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#e----j---.sd"><i class="fa fa-check"></i><b>1.5.5</b> e) Множество столбцов в <code>j</code> - <code>.SD</code></a></li>
<li class="chapter" data-level="1.5.6" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#f--.sd---"><i class="fa fa-check"></i><b>1.5.6</b> f) Поднабор <code>.SD</code> для каждой группы:</a></li>
<li class="chapter" data-level="1.5.7" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#g---j--"><i class="fa fa-check"></i><b>1.5.7</b> g) Зачем делать <code>j</code> настолько гибким?</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#section-1.6"><i class="fa fa-check"></i><b>1.6</b> Резюме</a><ul>
<li class="chapter" data-level="1.6.1" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#-i"><i class="fa fa-check"></i><b>1.6.1</b> Использование <code>i</code>:</a></li>
<li class="chapter" data-level="1.6.2" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#-j"><i class="fa fa-check"></i><b>1.6.2</b> Использование <code>j</code>:</a></li>
<li class="chapter" data-level="1.6.3" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#-by"><i class="fa fa-check"></i><b>1.6.3</b> Использование <code>by</code>:</a></li>
<li class="chapter" data-level="1.6.4" data-path="01_data.table_intro.html"><a href="01_data.table_intro.html#--"><i class="fa fa-check"></i><b>1.6.4</b> И запомните совет:</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html"><i class="fa fa-check"></i><b>2</b> Ключи и создание поднаборов на основе быстрого бинарного поиска</a><ul>
<li class="chapter" data-level="2.1" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#section-2.1"><i class="fa fa-check"></i><b>2.1</b> Данные</a></li>
<li class="chapter" data-level="2.2" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#section-2.2"><i class="fa fa-check"></i><b>2.2</b> Введение</a></li>
<li class="chapter" data-level="2.3" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#section-2.3"><i class="fa fa-check"></i><b>2.3</b> 1. Ключи</a><ul>
<li class="chapter" data-level="2.3.1" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#a---"><i class="fa fa-check"></i><b>2.3.1</b> a) Что такое <em>ключ</em>?</a></li>
<li class="chapter" data-level="2.3.2" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#b--------data.table"><i class="fa fa-check"></i><b>2.3.2</b> b) Установка, получение и использование ключей в таблице <em>data.table</em></a></li>
<li class="chapter" data-level="2.3.3" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#c----"><i class="fa fa-check"></i><b>2.3.3</b> c) Ключи и множественные столбцы</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#---j--by"><i class="fa fa-check"></i><b>2.4</b> 2. Комбинирование ключей с <code>j</code> и <code>by</code></a><ul>
<li class="chapter" data-level="2.4.1" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#a---j"><i class="fa fa-check"></i><b>2.4.1</b> a) Выбор в <code>j</code></a></li>
<li class="chapter" data-level="2.4.2" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#b--"><i class="fa fa-check"></i><b>2.4.2</b> b) Цепочки операций</a></li>
<li class="chapter" data-level="2.4.3" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#c-----j"><i class="fa fa-check"></i><b>2.4.3</b> c) Вычислить или <em>выполнить</em> в <code>j</code></a></li>
<li class="chapter" data-level="2.4.4" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#d--------j"><i class="fa fa-check"></i><b>2.4.4</b> d) <em>Частичное присваивание</em> по ссылке с использованием <code>:=</code> в <code>j</code></a></li>
<li class="chapter" data-level="2.4.5" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#e----by"><i class="fa fa-check"></i><b>2.4.5</b> e) Агрегирование с использованием <code>by</code></a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#----mult--nomatch"><i class="fa fa-check"></i><b>2.5</b> 3. Дополнительные аргументы - <code>mult</code> и <code>nomatch</code></a><ul>
<li class="chapter" data-level="2.5.1" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#a--mult"><i class="fa fa-check"></i><b>2.5.1</b> a) Аргумент <code>mult</code></a></li>
<li class="chapter" data-level="2.5.2" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#b--nomatch"><i class="fa fa-check"></i><b>2.5.2</b> b) Аргумент <code>nomatch</code></a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#------"><i class="fa fa-check"></i><b>2.6</b> 4. Бинарный поиск в сравнении со сканированием вектора</a><ul>
<li class="chapter" data-level="2.6.1" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#a---"><i class="fa fa-check"></i><b>2.6.1</b> a) Производительность бинарного поиска</a></li>
<li class="chapter" data-level="2.6.2" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#b-----data.table-----"><i class="fa fa-check"></i><b>2.6.2</b> b) Почему использование ключей в <em>data.table</em> приводит к молниеносному созданию поднаборов?</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#-1"><i class="fa fa-check"></i><b>2.7</b> Резюме</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="03_data.table_reference.html"><a href="03_data.table_reference.html"><i class="fa fa-check"></i><b>3</b> Семантика ссылок</a><ul>
<li class="chapter" data-level="3.1" data-path="03_data.table_reference.html"><a href="03_data.table_reference.html#ch3.1"><i class="fa fa-check"></i><b>3.1</b> Данные</a></li>
<li class="chapter" data-level="3.2" data-path="03_data.table_reference.html"><a href="03_data.table_reference.html#ch3.2"><i class="fa fa-check"></i><b>3.2</b> Введение</a></li>
<li class="chapter" data-level="3.3" data-path="03_data.table_reference.html"><a href="03_data.table_reference.html#ch3.3"><i class="fa fa-check"></i><b>3.3</b> 1. Семантика ссылок</a><ul>
<li class="chapter" data-level="3.3.1" data-path="03_data.table_reference.html"><a href="03_data.table_reference.html#ch3.3.1"><i class="fa fa-check"></i><b>3.3.1</b> a) Бэкграунд</a></li>
<li class="chapter" data-level="3.3.2" data-path="03_data.table_reference.html"><a href="03_data.table_reference.html#b-"><i class="fa fa-check"></i><b>3.3.2</b> b) Оператор <code id="ch3.3.2">:=</code></a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="03_data.table_reference.html"><a href="03_data.table_reference.html#add_del"><i class="fa fa-check"></i><b>3.4</b> 2. Добавление/обновление/удаление столбцов <em>по ссылке</em></a><ul>
<li class="chapter" data-level="3.4.1" data-path="03_data.table_reference.html"><a href="03_data.table_reference.html#ch3.2.1"><i class="fa fa-check"></i><b>3.4.1</b> a) Добавление столбцов по ссылке</a></li>
<li class="chapter" data-level="3.4.2" data-path="03_data.table_reference.html"><a href="03_data.table_reference.html#ch3.2.2"><i class="fa fa-check"></i><b>3.4.2</b> b) Обновление некоторых строк в столбцах по ссылке - <em>частичное присваивание</em> по ссылке</a></li>
<li class="chapter" data-level="3.4.3" data-path="03_data.table_reference.html"><a href="03_data.table_reference.html#ch3.2.3"><i class="fa fa-check"></i><b>3.4.3</b> c) Удаление столбца по ссылке</a></li>
<li class="chapter" data-level="3.4.4" data-path="03_data.table_reference.html"><a href="03_data.table_reference.html#d------by"><i class="fa fa-check"></i><b>3.4.4</b> d) <code>:=</code> вместе с группировкой при помощи <code id="ch3.2.4">by</code></a></li>
<li class="chapter" data-level="3.4.5" data-path="03_data.table_reference.html"><a href="03_data.table_reference.html#e---"><i class="fa fa-check"></i><b>3.4.5</b> e) Множественные столбцы и <code id="ch3.2.5">:=</code></a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="03_data.table_reference.html"><a href="03_data.table_reference.html#-copy"><i class="fa fa-check"></i><b>3.5</b> 3 <code>:=</code> и <code id="eq_copy">copy()</code></a><ul>
<li class="chapter" data-level="3.5.1" data-path="03_data.table_reference.html"><a href="03_data.table_reference.html#ch3.3.1"><i class="fa fa-check"></i><b>3.5.1</b> a) Использование оператора <code>:=</code> ради его побочного эффекта</a></li>
<li class="chapter" data-level="3.5.2" data-path="03_data.table_reference.html"><a href="03_data.table_reference.html#b--copy"><i class="fa fa-check"></i><b>3.5.2</b> b) Функция <code id="fun_copy">copy()</code></a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="03_data.table_reference.html"><a href="03_data.table_reference.html#ch3.4"><i class="fa fa-check"></i><b>3.6</b> Резюме</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="04_data.table_reshaping.html"><a href="04_data.table_reshaping.html"><i class="fa fa-check"></i><b>4</b> Эффективное переформатирование данных при помощи data.table</a><ul>
<li class="chapter" data-level="4.1" data-path="04_data.table_reshaping.html"><a href="04_data.table_reshaping.html#ch4.1"><i class="fa fa-check"></i><b>4.1</b> Данные</a></li>
<li class="chapter" data-level="4.2" data-path="04_data.table_reshaping.html"><a href="04_data.table_reshaping.html#ch4.2"><i class="fa fa-check"></i><b>4.2</b> Введение</a></li>
<li class="chapter" data-level="4.3" data-path="04_data.table_reshaping.html"><a href="04_data.table_reshaping.html#ch4.3"><i class="fa fa-check"></i><b>4.3</b> 1. Базовая функциональность</a><ul>
<li class="chapter" data-level="4.3.1" data-path="04_data.table_reshaping.html"><a href="04_data.table_reshaping.html#ch4.3.1"><i class="fa fa-check"></i><b>4.3.1</b> a) <code>melt</code>ing таблиц <em>data.tables</em> (переформатирование из “широкого” формата в “длинный”)</a></li>
<li class="chapter" data-level="4.3.2" data-path="04_data.table_reshaping.html"><a href="04_data.table_reshaping.html#ch4.3.2"><i class="fa fa-check"></i><b>4.3.2</b> b) <code>cast</code>ing таблиц <em>data.tables</em> (переформатирование из “длинного” формата в “широкий”)</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="04_data.table_reshaping.html"><a href="04_data.table_reshaping.html#---meltdcast"><i class="fa fa-check"></i><b>4.4</b> 2. Ограничения базового подхода <code id="ch4.4">melt/dcast</code></a></li>
<li class="chapter" data-level="4.5" data-path="04_data.table_reshaping.html"><a href="04_data.table_reshaping.html#ch4.5"><i class="fa fa-check"></i><b>4.5</b> 3. Расширенная (новая) функциональность</a><ul>
<li class="chapter" data-level="4.5.1" data-path="04_data.table_reshaping.html"><a href="04_data.table_reshaping.html#a---melt"><i class="fa fa-check"></i><b>4.5.1</b> a) Расширенная функция <code id="ch4.5.1">melt</code></a></li>
<li class="chapter" data-level="4.5.2" data-path="04_data.table_reshaping.html"><a href="04_data.table_reshaping.html#b---dcast"><i class="fa fa-check"></i><b>4.5.2</b> b) Расширенная функция <code id="ch4.5.2">dcast</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="02_data.table_keys.html"><a href="02_data.table_keys.html#---"><i class="fa fa-check"></i><b>5</b> Вторичные индексы и автоиндексирование</a><ul>
<li class="chapter" data-level="5.1" data-path="05_data.table_second_ind.html"><a href="05_data.table_second_ind.html"><i class="fa fa-check"></i><b>5.1</b> Данные</a></li>
<li class="chapter" data-level="5.2" data-path="05_data.table_second_ind.html"><a href="05_data.table_second_ind.html#ch5.2"><i class="fa fa-check"></i><b>5.2</b> Введение</a></li>
<li class="chapter" data-level="5.3" data-path="05_data.table_second_ind.html"><a href="05_data.table_second_ind.html#ch5.3"><i class="fa fa-check"></i><b>5.3</b> 1. Вторичные индексы</a><ul>
<li class="chapter" data-level="5.3.1" data-path="05_data.table_second_ind.html"><a href="05_data.table_second_ind.html#ch5.3.1"><i class="fa fa-check"></i><b>5.3.1</b> a) Что такое вторичные индексы?</a></li>
<li class="chapter" data-level="5.3.2" data-path="05_data.table_second_ind.html"><a href="05_data.table_second_ind.html#ch5.3.2"><i class="fa fa-check"></i><b>5.3.2</b> b) Установка и получение вторичных индексов</a></li>
<li class="chapter" data-level="5.3.3" data-path="05_data.table_second_ind.html"><a href="05_data.table_second_ind.html#ch5.3.3"><i class="fa fa-check"></i><b>5.3.3</b> c) Почему нам нужны вторичные индексы?</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="05_data.table_second_ind.html"><a href="05_data.table_second_ind.html#ch5.4"><i class="fa fa-check"></i><b>5.4</b> 2. Быстрое создание поднаборов с использованием аргумента <code>on</code> и вторичных индексов</a><ul>
<li class="chapter" data-level="5.4.1" data-path="05_data.table_second_ind.html"><a href="05_data.table_second_ind.html#a-----i"><i class="fa fa-check"></i><b>5.4.1</b> a) Быстрое создание поднаборов в <code id="ch5.4.1">i</code></a></li>
<li class="chapter" data-level="5.4.2" data-path="05_data.table_second_ind.html"><a href="05_data.table_second_ind.html#b---j"><i class="fa fa-check"></i><b>5.4.2</b> b) Выбор в <code id="ch5.4.2">j</code></a></li>
<li class="chapter" data-level="5.4.3" data-path="05_data.table_second_ind.html"><a href="05_data.table_second_ind.html#ch5.4.3"><i class="fa fa-check"></i><b>5.4.3</b> c) Объединение в цепочку</a></li>
<li class="chapter" data-level="5.4.4" data-path="05_data.table_second_ind.html"><a href="05_data.table_second_ind.html#d-----j"><i class="fa fa-check"></i><b>5.4.4</b> d) Вычислить или <em>выполнить</em> в <code id="ch5.4.4">j</code></a></li>
<li class="chapter" data-level="5.4.5" data-path="05_data.table_second_ind.html"><a href="05_data.table_second_ind.html#e--------j"><i class="fa fa-check"></i><b>5.4.5</b> e) <em>Частичное присваивание</em> по ссылке с использованием <code>:=</code> в <code id="ch5.4.5">j</code></a></li>
<li class="chapter" data-level="5.4.6" data-path="05_data.table_second_ind.html"><a href="05_data.table_second_ind.html#f----by"><i class="fa fa-check"></i><b>5.4.6</b> f) Агрегирование с использованием <code id="ch5.4.6">by</code></a></li>
<li class="chapter" data-level="5.4.7" data-path="05_data.table_second_ind.html"><a href="05_data.table_second_ind.html#g--mult"><i class="fa fa-check"></i><b>5.4.7</b> g) Аргумент <code id="ch5.4.7">mult</code></a></li>
<li class="chapter" data-level="5.4.8" data-path="05_data.table_second_ind.html"><a href="05_data.table_second_ind.html#h--nomatch"><i class="fa fa-check"></i><b>5.4.8</b> h) Аргумент <code id="ch5.4.8">nomatch</code></a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="05_data.table_second_ind.html"><a href="05_data.table_second_ind.html#ch5.5"><i class="fa fa-check"></i><b>5.5</b> 3. Автоиндексирование</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Руководство по data.table</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ch3" class="section level1">
<h1><span class="header-section-number">3</span> Семантика ссылок</h1>
<p>В этой виньетке обсуждается семантика ссылок в <em>data.table</em>, которая позволяет <em>добавлять/обновлять/удалять</em> столбцы в <em>data.table</em> <em>по ссылке</em>, а также комбинирование с <code>i</code> и <code>by</code>. Она предназначена для тех, кто уже знаком с синтаксисом <em>data.table</em>, его общим видом, способом выбора строк в <code>i</code>, выбором и вычислением столбцов, выполнением агрегирования по группам. Если вы не знакомы с этими концепциями, пожалуйста, прочтите сперва виньетку “Введение в data.table”.</p>
<div id="ch3.1" class="section level2">
<h2><span class="header-section-number">3.1</span> Данные</h2>
<p>Мы будем использовать набор данных <code>flights</code>, так же как в виньетке “Введение в data.table”.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;https://raw.githubusercontent.com/wiki/arunsrinivasan/flights/NYCflights14/flights14.csv&quot;</span>)
flights
<span class="co">#         year month day dep_time dep_delay arr_time arr_delay cancelled carrier tailnum flight</span>
<span class="co">#      1: 2014     1   1      914        14     1238        13         0      AA  N338AA      1</span>
<span class="co">#      2: 2014     1   1     1157        -3     1523        13         0      AA  N335AA      3</span>
<span class="co">#      3: 2014     1   1     1902         2     2224         9         0      AA  N327AA     21</span>
<span class="co">#      4: 2014     1   1      722        -8     1014       -26         0      AA  N3EHAA     29</span>
<span class="co">#      5: 2014     1   1     1347         2     1706         1         0      AA  N319AA    117</span>
<span class="co">#     ---                                                                                      </span>
<span class="co"># 253312: 2014    10  31     1459         1     1747       -30         0      UA  N23708   1744</span>
<span class="co"># 253313: 2014    10  31      854        -5     1147       -14         0      UA  N33132   1758</span>
<span class="co"># 253314: 2014    10  31     1102        -8     1311        16         0      MQ  N827MQ   3591</span>
<span class="co"># 253315: 2014    10  31     1106        -4     1325        15         0      MQ  N511MQ   3592</span>
<span class="co"># 253316: 2014    10  31      824        -5     1045         1         0      MQ  N813MQ   3599</span>
<span class="co">#         origin dest air_time distance hour min</span>
<span class="co">#      1:    JFK  LAX      359     2475    9  14</span>
<span class="co">#      2:    JFK  LAX      363     2475   11  57</span>
<span class="co">#      3:    JFK  LAX      351     2475   19   2</span>
<span class="co">#      4:    LGA  PBI      157     1035    7  22</span>
<span class="co">#      5:    JFK  LAX      350     2475   13  47</span>
<span class="co">#     ---                                       </span>
<span class="co"># 253312:    LGA  IAH      201     1416   14  59</span>
<span class="co"># 253313:    EWR  IAH      189     1400    8  54</span>
<span class="co"># 253314:    LGA  RDU       83      431   11   2</span>
<span class="co"># 253315:    LGA  DTW       75      502   11   6</span>
<span class="co"># 253316:    LGA  SDF      110      659    8  24</span>
<span class="kw">dim</span>(flights)
<span class="co"># [1] 253316     17</span></code></pre></div>
</div>
<div id="ch3.2" class="section level2">
<h2><span class="header-section-number">3.2</span> Введение</h2>
<p>В этой виньетке мы:</p>
<ol style="list-style-type: decimal">
<li><p>сперва коротко обсудим семантику ссылок и рассмотрим две разные формы использования оператора <code>:=</code></p></li>
<li><p>затем увидим, как мы можем <em>добавлять/обновлять/удалять</em> столбцы по ссылке в <code>j</code> с использованием <code>:=</code>, и как это комбинировать с <code>i</code> и <code>by</code></p></li>
<li><p>и, наконец, мы увидим, как использовать оператор <code>:=</code> ради его побочного эффекта, и как мы можем его избежать при помощи <code>copy()</code>.</p></li>
</ol>
</div>
<div id="ch3.3" class="section level2">
<h2><span class="header-section-number">3.3</span> 1. Семантика ссылок</h2>
<p>Результатом всех операций, которые мы видели в предыдущей виньетке, был новый набор данных. Мы увидим, как <em>добавлять</em> новые столбцы, <em>обновлять</em> или <em>удалять</em> существующие столбцы в исходных данных.</p>
<div id="ch3.3.1" class="section level3">
<h3><span class="header-section-number">3.3.1</span> a) Бэкграунд</h3>
<p>Прежде чем заняться семантикой ссылок, рассмотрим следующую таблицу <em>data.frame</em>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">DF =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">ID =</span> <span class="kw">c</span>(<span class="st">&quot;b&quot;</span>,<span class="st">&quot;b&quot;</span>,<span class="st">&quot;b&quot;</span>,<span class="st">&quot;a&quot;</span>,<span class="st">&quot;a&quot;</span>,<span class="st">&quot;c&quot;</span>), <span class="dt">a =</span> <span class="dv">1</span>:<span class="dv">6</span>, <span class="dt">b =</span> <span class="dv">7</span>:<span class="dv">12</span>, <span class="dt">c=</span><span class="dv">13</span>:<span class="dv">18</span>)
DF
<span class="co">#   ID a  b  c</span>
<span class="co"># 1  b 1  7 13</span>
<span class="co"># 2  b 2  8 14</span>
<span class="co"># 3  b 3  9 15</span>
<span class="co"># 4  a 4 10 16</span>
<span class="co"># 5  a 5 11 17</span>
<span class="co"># 6  c 6 12 18</span></code></pre></div>
<p>Когда вы выполняем:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">DF$c &lt;-<span class="st"> </span><span class="dv">18</span>:<span class="dv">13</span>               <span class="co"># (1) -- replace entire column</span>
<span class="co"># or</span>
DF$c[DF$ID ==<span class="st"> &quot;b&quot;</span>] &lt;-<span class="st"> </span><span class="dv">15</span>:<span class="dv">13</span> <span class="co"># (2) -- subassign in column &#39;c&#39;</span></code></pre></div>
<p>и (1), и (2) приводят к созданию глубокой копии всей таблицы <em>data.frame</em> в <code>R</code> версии <code>&lt; 3.1</code>. Данные копируются больше одного раза. Для увеличения производительности путем избегания этих ненужных копий <em>data.table</em> использует доступный, но неиспользуемый в R оператор <code>:=</code>.</p>
<p>Большое увеличение производительности было сделано в <code>R v3.1</code>, в результате чего в случае (1) создается <em>поверхностная</em>, а не <em>глубокая</em> копия. Тем не менее, для (2) по-прежнему создается <em>глубокая</em> копия всего столбца даже в <code>R v3.1+</code>. Это означает, что чем больше столбцов участвуют в частичном присвоении в <em>одном</em> запросе, тем более <em>глубокие</em> копии создает R.</p>
<div id="ch3.3.1.1" class="section level4">
<h4><span class="header-section-number">3.3.1.1</span> <em>Поверхностная</em> копия против <em>глубокой</em> копии</h4>
<p><em>Поверхностная</em> копия является всего лишь копией вектора-указателя столбцов (в соответствии со столбцами в <em>data.frame</em> или <em>data.table</em>). Настоящие данные физически не копируются в памяти.</p>
<p>С другой стороны, <em>глубокая</em> копия создает новую копию всех данных в новой области памяти.</p>
<p>С использованием оператора <code>:=</code> в <em>data.table</em> никакие копии не создаются ни в случае (1), ни в случае (2) независимо от используемой версии R. Причина этого в том, что оператор <code>:=</code> <em>на месте</em> обновляет столбцы <em>data.table</em> (<em>по ссылке</em>).</p>
</div>
</div>
<div id="b-" class="section level3">
<h3><span class="header-section-number">3.3.2</span> b) Оператор <code id="ch3.3.2">:=</code></h3>
<p>Может быть использован в <code>j</code> двумя способами:</p>
<ol style="list-style-type: lower-alpha">
<li>Форма <code>LHS := RHS</code></li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">DT[, <span class="kw">c</span>(<span class="st">&quot;colA&quot;</span>, <span class="st">&quot;colB&quot;</span>, ...) :<span class="er">=</span><span class="st"> </span><span class="kw">list</span>(valA, valB, ...)]

<span class="co"># when you have only one column to assign to you </span>
<span class="co"># can drop the quotes and list(), for convenience</span>
DT[, colA :<span class="er">=</span><span class="st"> </span>valA]</code></pre></div>
<ol start="2" style="list-style-type: lower-alpha">
<li>Функциональная форма</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">DT[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(<span class="dt">colA =</span> valA, <span class="co"># valA is assigned to colA</span>
          <span class="dt">colB =</span> valB, <span class="co"># valB is assigned to colB</span>
          ...
)]</code></pre></div>
<p>Обратите внимаени, что приведенныый выше код объясняет, как можно использовать <code>:=</code>. Это не рабочие примеры. Мы начнем использовать этот оператор с таблицей <em>data.table</em> <code>flights</code> в следующем разделе.</p>
<ul>
<li><p>Форма (a) удобна для программирования и особенно полезна, когда вы не знаете заранее столбцы для присваивания значений.</p></li>
<li><p>С другой стороны, форма (b) удобна, когда вы хотите записать комментарии на будущее.</p></li>
<li><p>Результат возвращается <em>скрыто</em>.</p></li>
<li><p>Поскольку оператор <code>:=</code> доступен в <code>j</code>, мы можем комбинировать его с операциями <code>i</code> и <code>by</code>, подобно операциям агрегирования, которые мы видели в предыдущей виньетке.</p></li>
</ul>
<p>Обратите внимание, что в двух формах <code>:=</code>, показанных выше, мы не присваиваем результат переменной, потому что не нуждаемся в этом. Исходная таблица <em>data.table</em> изменяется по ссылке. Давайте рассмотрим примеры, чтобы понять, что под этим подразумевается.</p>
<p>В оставшейся части виньетки мы будем работать с набором данных <code>flights</code>.</p>
</div>
</div>
<div id="add_del" class="section level2">
<h2><span class="header-section-number">3.4</span> 2. Добавление/обновление/удаление столбцов <em>по ссылке</em></h2>
<div id="ch3.2.1" class="section level3">
<h3><span class="header-section-number">3.4.1</span> a) Добавление столбцов по ссылке</h3>
<div id="ch3.2.1.1" class="section level5">
<h5><span class="header-section-number">3.4.1.0.1</span> - Как мы можем добавить столбцы <em>скорость</em> и <em>общая задержка</em> каждого рейса в таблицу <em>data.table</em> <code>flights</code>?</h5>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(<span class="dt">speed =</span> distance /<span class="st"> </span>(air_time/<span class="dv">60</span>), <span class="co"># speed in km/hr</span>
               <span class="dt">delay =</span> arr_delay +<span class="st"> </span>dep_delay)]   <span class="co"># delay in minutes</span>
<span class="kw">head</span>(flights)
<span class="co">#    year month day dep_time dep_delay arr_time arr_delay cancelled carrier tailnum flight origin</span>
<span class="co"># 1: 2014     1   1      914        14     1238        13         0      AA  N338AA      1    JFK</span>
<span class="co"># 2: 2014     1   1     1157        -3     1523        13         0      AA  N335AA      3    JFK</span>
<span class="co"># 3: 2014     1   1     1902         2     2224         9         0      AA  N327AA     21    JFK</span>
<span class="co"># 4: 2014     1   1      722        -8     1014       -26         0      AA  N3EHAA     29    LGA</span>
<span class="co"># 5: 2014     1   1     1347         2     1706         1         0      AA  N319AA    117    JFK</span>
<span class="co"># 6: 2014     1   1     1824         4     2145         0         0      AA  N3DEAA    119    EWR</span>
<span class="co">#    dest air_time distance hour min    speed delay</span>
<span class="co"># 1:  LAX      359     2475    9  14 413.6490    27</span>
<span class="co"># 2:  LAX      363     2475   11  57 409.0909    10</span>
<span class="co"># 3:  LAX      351     2475   19   2 423.0769    11</span>
<span class="co"># 4:  PBI      157     1035    7  22 395.5414   -34</span>
<span class="co"># 5:  LAX      350     2475   13  47 424.2857     3</span>
<span class="co"># 6:  LAX      339     2454   18  24 434.3363     4</span>

## alternatively, using the &#39;LHS := RHS&#39; form
<span class="co"># flights[, c(&quot;speed&quot;, &quot;delay&quot;) := list(distance/(air_time/60), arr_delay + dep_delay)]</span></code></pre></div>
</div>
<div id="ch3.2.1.2" class="section level4">
<h4><span class="header-section-number">3.4.1.1</span> Обратите внимание</h4>
<ul>
<li><p>Мы не присвоили разультат переменной <code>flights</code>.</p></li>
<li><p>Таблица <code>flights</code> теперь содержит два новых столбца. Это то, что мы подразумеваем под добавлением по ссылке.</p></li>
<li><p>Мы использовали функциональную форму, так что мы можем добавлять комментарии сбоку для объяснения, что делают эти вычисления. Вы также можете видеть форму <code>LHS := RHS</code> (закомментированную).</p></li>
</ul>
</div>
</div>
<div id="ch3.2.2" class="section level3">
<h3><span class="header-section-number">3.4.2</span> b) Обновление некоторых строк в столбцах по ссылке - <em>частичное присваивание</em> по ссылке</h3>
<p>Давайте взглянем на все значения <code>hours</code>, доступные в таблице <em>data.table</em> <code>flights</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># get all &#39;hours&#39; in flights</span>
flights[, <span class="kw">sort</span>(<span class="kw">unique</span>(hour))]
<span class="co">#  [1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24</span></code></pre></div>
<p>Мы видим, что имеется 25 уникальных значений - есть и 0, и 24. Давайте заменим 24 на 0.</p>
<div id="ch3.2.2.1" class="section level4">
<h4><span class="header-section-number">3.4.2.1</span> – Заменить строки, где <code>hour == 24</code>, на 0</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># subassign by reference</span>
flights[hour ==<span class="st"> </span>24L, hour :<span class="er">=</span><span class="st"> </span>0L]</code></pre></div>
<ul>
<li><p>Мы можем использовать <code>i</code> вместе с <code>:=</code> в <code>j</code> тем же способом, как мы видели в виньетке “Введение в data.table”.</p></li>
<li><p>Столбец <code>hour</code> заменяется <code>0</code> только для индексов строк, для которых условие <code>hour == 24L</code>, определенное в <code>i</code>, возвращает <code>TRUE</code>.</p></li>
<li><p><code>:=</code> возвращает результат скрыто. Иногда бывает нужно увидеть результат после присваивания. Мы можем добиться этого, добавив пустой оператор <code>[]</code> в конце запроса, как показано ниже:</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights[hour ==<span class="st"> </span>24L, hour :<span class="er">=</span><span class="st"> </span>0L][]
<span class="co">#         year month day dep_time dep_delay arr_time arr_delay cancelled carrier tailnum flight</span>
<span class="co">#      1: 2014     1   1      914        14     1238        13         0      AA  N338AA      1</span>
<span class="co">#      2: 2014     1   1     1157        -3     1523        13         0      AA  N335AA      3</span>
<span class="co">#      3: 2014     1   1     1902         2     2224         9         0      AA  N327AA     21</span>
<span class="co">#      4: 2014     1   1      722        -8     1014       -26         0      AA  N3EHAA     29</span>
<span class="co">#      5: 2014     1   1     1347         2     1706         1         0      AA  N319AA    117</span>
<span class="co">#     ---                                                                                      </span>
<span class="co"># 253312: 2014    10  31     1459         1     1747       -30         0      UA  N23708   1744</span>
<span class="co"># 253313: 2014    10  31      854        -5     1147       -14         0      UA  N33132   1758</span>
<span class="co"># 253314: 2014    10  31     1102        -8     1311        16         0      MQ  N827MQ   3591</span>
<span class="co"># 253315: 2014    10  31     1106        -4     1325        15         0      MQ  N511MQ   3592</span>
<span class="co"># 253316: 2014    10  31      824        -5     1045         1         0      MQ  N813MQ   3599</span>
<span class="co">#         origin dest air_time distance hour min    speed delay</span>
<span class="co">#      1:    JFK  LAX      359     2475    9  14 413.6490    27</span>
<span class="co">#      2:    JFK  LAX      363     2475   11  57 409.0909    10</span>
<span class="co">#      3:    JFK  LAX      351     2475   19   2 423.0769    11</span>
<span class="co">#      4:    LGA  PBI      157     1035    7  22 395.5414   -34</span>
<span class="co">#      5:    JFK  LAX      350     2475   13  47 424.2857     3</span>
<span class="co">#     ---                                                      </span>
<span class="co"># 253312:    LGA  IAH      201     1416   14  59 422.6866   -29</span>
<span class="co"># 253313:    EWR  IAH      189     1400    8  54 444.4444   -19</span>
<span class="co"># 253314:    LGA  RDU       83      431   11   2 311.5663     8</span>
<span class="co"># 253315:    LGA  DTW       75      502   11   6 401.6000    11</span>
<span class="co"># 253316:    LGA  SDF      110      659    8  24 359.4545    -4</span></code></pre></div>
<p>Давайте взглянем на все значения <code>hours</code> для проверки.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># check again for &#39;24&#39;</span>
flights[, <span class="kw">sort</span>(<span class="kw">unique</span>(hour))]
<span class="co">#  [1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</span></code></pre></div>
</div>
</div>
<div id="ch3.2.3" class="section level3">
<h3><span class="header-section-number">3.4.3</span> c) Удаление столбца по ссылке</h3>
<div id="--delay" class="section level4">
<h4><span class="header-section-number">3.4.3.1</span> – Удаление столбца <code id="ch3.2.3.1">delay</code></h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights[, <span class="kw">c</span>(<span class="st">&quot;delay&quot;</span>) :<span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
<span class="kw">head</span>(flights)
<span class="co">#    year month day dep_time dep_delay arr_time arr_delay cancelled carrier tailnum flight origin</span>
<span class="co"># 1: 2014     1   1      914        14     1238        13         0      AA  N338AA      1    JFK</span>
<span class="co"># 2: 2014     1   1     1157        -3     1523        13         0      AA  N335AA      3    JFK</span>
<span class="co"># 3: 2014     1   1     1902         2     2224         9         0      AA  N327AA     21    JFK</span>
<span class="co"># 4: 2014     1   1      722        -8     1014       -26         0      AA  N3EHAA     29    LGA</span>
<span class="co"># 5: 2014     1   1     1347         2     1706         1         0      AA  N319AA    117    JFK</span>
<span class="co"># 6: 2014     1   1     1824         4     2145         0         0      AA  N3DEAA    119    EWR</span>
<span class="co">#    dest air_time distance hour min    speed</span>
<span class="co"># 1:  LAX      359     2475    9  14 413.6490</span>
<span class="co"># 2:  LAX      363     2475   11  57 409.0909</span>
<span class="co"># 3:  LAX      351     2475   19   2 423.0769</span>
<span class="co"># 4:  PBI      157     1035    7  22 395.5414</span>
<span class="co"># 5:  LAX      350     2475   13  47 424.2857</span>
<span class="co"># 6:  LAX      339     2454   18  24 434.3363</span>

## or using the functional form
<span class="co"># flights[, `:=`(delay = NULL)]</span></code></pre></div>
<ul>
<li><p>Присвоение значения <code>NULL</code> столбцу удаляет его. И это происходит мгновенно.</p></li>
<li><p>Мы можем такое передавать имена столбцов вместо их имен в <code>LHS</code>, хотя хорошая практика программирования заключается в использовании имен.</p></li>
<li><p>Когда нужно удалить всего один столбец, мы можем опустить <code>c()</code> и двойные кавычки и использовать для удобства просто имя столбца. Эквивалент кода выше:</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights[, delay :<span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]</code></pre></div>
</div>
</div>
<div id="d------by" class="section level3">
<h3><span class="header-section-number">3.4.4</span> d) <code>:=</code> вместе с группировкой при помощи <code id="ch3.2.4">by</code></h3>
<p>В разделе 2b мы уже видели, как использовать <code>:=</code> совместно с <code>i</code>. Давайте посмотрим, как мы можем использовать <code>:=</code> в сочетании с <code>by</code>.</p>
<div id="ch3.2.4.1" class="section level4">
<h4><span class="header-section-number">3.4.4.1</span> - Как мы можем добавить новый столбец, содержащий максимальную скорость для каждой пары <code>origin, dest</code>?</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights[, max_speed :<span class="er">=</span><span class="st"> </span><span class="kw">max</span>(speed), by=.(origin, dest)]
<span class="kw">head</span>(flights)
<span class="co">#    year month day dep_time dep_delay arr_time arr_delay cancelled carrier tailnum flight origin</span>
<span class="co"># 1: 2014     1   1      914        14     1238        13         0      AA  N338AA      1    JFK</span>
<span class="co"># 2: 2014     1   1     1157        -3     1523        13         0      AA  N335AA      3    JFK</span>
<span class="co"># 3: 2014     1   1     1902         2     2224         9         0      AA  N327AA     21    JFK</span>
<span class="co"># 4: 2014     1   1      722        -8     1014       -26         0      AA  N3EHAA     29    LGA</span>
<span class="co"># 5: 2014     1   1     1347         2     1706         1         0      AA  N319AA    117    JFK</span>
<span class="co"># 6: 2014     1   1     1824         4     2145         0         0      AA  N3DEAA    119    EWR</span>
<span class="co">#    dest air_time distance hour min    speed max_speed</span>
<span class="co"># 1:  LAX      359     2475    9  14 413.6490  526.5957</span>
<span class="co"># 2:  LAX      363     2475   11  57 409.0909  526.5957</span>
<span class="co"># 3:  LAX      351     2475   19   2 423.0769  526.5957</span>
<span class="co"># 4:  PBI      157     1035    7  22 395.5414  517.5000</span>
<span class="co"># 5:  LAX      350     2475   13  47 424.2857  526.5957</span>
<span class="co"># 6:  LAX      339     2454   18  24 434.3363  518.4507</span></code></pre></div>
<ul>
<li><p>Мы добавляем новый столбец <code>max_speed</code> по ссылке, используя оператор <code>:=</code>.</p></li>
<li><p>Мы задаем столбцы для группировки, как было показано в виньетке “Введение в data.table”. Для каждой группы было вычислено выражение <code>max(speed)</code>, которое возвращает единственное значение. Это выражение повторяется, чтобы соответствовать длине группы. Еще раз: никакие копии не создаются. Таблица <em>data.table</em> <code>flights</code> изменяется на месте.</p></li>
<li><p>Мы также можем задать <code>by</code> как символьный вектор, как мы видели в виньетке “Введение в data.table”, например, <code>by = c(&quot;origin&quot;, &quot;dest&quot;)</code>.</p></li>
</ul>
</div>
</div>
<div id="e---" class="section level3">
<h3><span class="header-section-number">3.4.5</span> e) Множественные столбцы и <code id="ch3.2.5">:=</code></h3>
<div id="ch3.2.5.1" class="section level4">
<h4><span class="header-section-number">3.4.5.1</span> - Как мы может добавить еще две колонки, рассчитав <code>max()</code> для <code>dep_delay</code> и <code>arr_delay</code> для каждого месяца, используя <code>.SD</code>?</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">in_cols  =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;dep_delay&quot;</span>, <span class="st">&quot;arr_delay&quot;</span>)
out_cols =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;max_dep_delay&quot;</span>, <span class="st">&quot;max_arr_delay&quot;</span>)
flights[, <span class="kw">c</span>(out_cols) :<span class="er">=</span><span class="st"> </span><span class="kw">lapply</span>(.SD, max), by =<span class="st"> </span>month, .SDcols =<span class="st"> </span>in_cols]
<span class="kw">head</span>(flights)
<span class="co">#    year month day dep_time dep_delay arr_time arr_delay cancelled carrier tailnum flight origin</span>
<span class="co"># 1: 2014     1   1      914        14     1238        13         0      AA  N338AA      1    JFK</span>
<span class="co"># 2: 2014     1   1     1157        -3     1523        13         0      AA  N335AA      3    JFK</span>
<span class="co"># 3: 2014     1   1     1902         2     2224         9         0      AA  N327AA     21    JFK</span>
<span class="co"># 4: 2014     1   1      722        -8     1014       -26         0      AA  N3EHAA     29    LGA</span>
<span class="co"># 5: 2014     1   1     1347         2     1706         1         0      AA  N319AA    117    JFK</span>
<span class="co"># 6: 2014     1   1     1824         4     2145         0         0      AA  N3DEAA    119    EWR</span>
<span class="co">#    dest air_time distance hour min    speed max_speed max_dep_delay max_arr_delay</span>
<span class="co"># 1:  LAX      359     2475    9  14 413.6490  526.5957           973           996</span>
<span class="co"># 2:  LAX      363     2475   11  57 409.0909  526.5957           973           996</span>
<span class="co"># 3:  LAX      351     2475   19   2 423.0769  526.5957           973           996</span>
<span class="co"># 4:  PBI      157     1035    7  22 395.5414  517.5000           973           996</span>
<span class="co"># 5:  LAX      350     2475   13  47 424.2857  526.5957           973           996</span>
<span class="co"># 6:  LAX      339     2454   18  24 434.3363  518.4507           973           996</span></code></pre></div>
<ul>
<li><p>Мы используем форму <code>LHS := RHS</code>. Сохраняем имена исходных и результирующих столбцов в отдельных переменных и передаем их в <code>SDcols</code> и <code>LHS</code> (для лучшей читаемости).</p></li>
<li><p>Отметим, что поскольку мы допускаем присваивание по ссылке без заключения имени столбца в кавычки для случая отдельного столбца, как объясняется в разделе 2c, мы не можем записать <code>out_cols := lapply(.SD, max)</code>. Это приведет к добавлению единственного столбца с именем <code>out_col</code>. Вместо этого мы должны использовать <code>c(out_cols)</code> или просто <code>(out_cols)</code>. Использования <code>(</code> вокруг имени переменной достаточно, чтобы различать эти два случая.</p></li>
<li><p>Форма <code>LHS := RHS</code> позволяет нам работать с несколькими столбцами. В RHS для расчета <code>max</code> для столбцов, заданных в <code>.SDcols</code>, мы используем базовую функцию <code>lapply()</code> вместе с <code>.SD</code> тем же способом, как мы видели ранее в виньетке “Введение в data.table”. Возвращается список из двух элементов, содержащих максимальные значения <code>dep_delay</code> и <code>arr_delay</code> для каждой группы.</p></li>
</ul>
<p>Прежде чем перейти к следующему разделу, давайте удалим новые столбцы <code>speed</code>, <code>max_speed</code>, <code>max_dep_delay</code> и <code>max_arr_delay</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># RHS gets automatically recycled to length of LHS</span>
flights[, <span class="kw">c</span>(<span class="st">&quot;speed&quot;</span>, <span class="st">&quot;max_speed&quot;</span>, <span class="st">&quot;max_dep_delay&quot;</span>, <span class="st">&quot;max_arr_delay&quot;</span>) :<span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
<span class="kw">head</span>(flights)
<span class="co">#    year month day dep_time dep_delay arr_time arr_delay cancelled carrier tailnum flight origin</span>
<span class="co"># 1: 2014     1   1      914        14     1238        13         0      AA  N338AA      1    JFK</span>
<span class="co"># 2: 2014     1   1     1157        -3     1523        13         0      AA  N335AA      3    JFK</span>
<span class="co"># 3: 2014     1   1     1902         2     2224         9         0      AA  N327AA     21    JFK</span>
<span class="co"># 4: 2014     1   1      722        -8     1014       -26         0      AA  N3EHAA     29    LGA</span>
<span class="co"># 5: 2014     1   1     1347         2     1706         1         0      AA  N319AA    117    JFK</span>
<span class="co"># 6: 2014     1   1     1824         4     2145         0         0      AA  N3DEAA    119    EWR</span>
<span class="co">#    dest air_time distance hour min</span>
<span class="co"># 1:  LAX      359     2475    9  14</span>
<span class="co"># 2:  LAX      363     2475   11  57</span>
<span class="co"># 3:  LAX      351     2475   19   2</span>
<span class="co"># 4:  PBI      157     1035    7  22</span>
<span class="co"># 5:  LAX      350     2475   13  47</span>
<span class="co"># 6:  LAX      339     2454   18  24</span></code></pre></div>
</div>
</div>
</div>
<div id="-copy" class="section level2">
<h2><span class="header-section-number">3.5</span> 3 <code>:=</code> и <code id="eq_copy">copy()</code></h2>
<p><code>:=</code> изменяет исходный объект по ссылке. Помимо возможностей, которые мы уже обсудили, иногда мы можем захотеть использовать возможность обновления по ссылке ради его побочного эффекта. А в других случаях может быть нежелательно изменять исходный объект, и тогда мы можем использовать функцию <code>copy()</code>, как мы сейчас увидим.</p>
<div id="ch3.3.1" class="section level3">
<h3><span class="header-section-number">3.5.1</span> a) Использование оператора <code>:=</code> ради его побочного эффекта</h3>
<p>Скажем, мы хотели бы создать функцию, которая будет возвращать максимальную скорость для каждого месяца. Но, в то же время, мы хотели бы добавить столбец <code>speed</code> в таблицу <code>flight</code>. Мы можем написать следующую простую функцию:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">foo &lt;-<span class="st"> </span>function(DT) {
  DT[, speed :<span class="er">=</span><span class="st"> </span>distance /<span class="st"> </span>(air_time/<span class="dv">60</span>)]
  DT[, .(<span class="dt">max_speed =</span> <span class="kw">max</span>(speed)), by=month]
}
ans =<span class="st"> </span><span class="kw">foo</span>(flights)
<span class="kw">head</span>(flights)
<span class="co">#    year month day dep_time dep_delay arr_time arr_delay cancelled carrier tailnum flight origin</span>
<span class="co"># 1: 2014     1   1      914        14     1238        13         0      AA  N338AA      1    JFK</span>
<span class="co"># 2: 2014     1   1     1157        -3     1523        13         0      AA  N335AA      3    JFK</span>
<span class="co"># 3: 2014     1   1     1902         2     2224         9         0      AA  N327AA     21    JFK</span>
<span class="co"># 4: 2014     1   1      722        -8     1014       -26         0      AA  N3EHAA     29    LGA</span>
<span class="co"># 5: 2014     1   1     1347         2     1706         1         0      AA  N319AA    117    JFK</span>
<span class="co"># 6: 2014     1   1     1824         4     2145         0         0      AA  N3DEAA    119    EWR</span>
<span class="co">#    dest air_time distance hour min    speed</span>
<span class="co"># 1:  LAX      359     2475    9  14 413.6490</span>
<span class="co"># 2:  LAX      363     2475   11  57 409.0909</span>
<span class="co"># 3:  LAX      351     2475   19   2 423.0769</span>
<span class="co"># 4:  PBI      157     1035    7  22 395.5414</span>
<span class="co"># 5:  LAX      350     2475   13  47 424.2857</span>
<span class="co"># 6:  LAX      339     2454   18  24 434.3363</span>
<span class="kw">head</span>(ans)
<span class="co">#    month max_speed</span>
<span class="co"># 1:     1  535.6425</span>
<span class="co"># 2:     2  535.6425</span>
<span class="co"># 3:     3  549.0756</span>
<span class="co"># 4:     4  585.6000</span>
<span class="co"># 5:     5  544.2857</span>
<span class="co"># 6:     6  608.5714</span></code></pre></div>
<ul>
<li><p>Обратите внимание, что новый столбец <code>speed</code> был добавлен в таблицу <em>data.table</em> <code>flights</code>, поскольку <code>:=</code> выполняет операции по ссылке. Поскольку <code>DT</code> (аргумент функции) и <code>flights</code> ссылаются на один и тот же объект в памяти, изменение <code>DT</code> также отражается на flights.</p></li>
<li><p><code>ans</code> содержит максимальную скорость для каждого месяца.</p></li>
</ul>
</div>
<div id="b--copy" class="section level3">
<h3><span class="header-section-number">3.5.2</span> b) Функция <code id="fun_copy">copy()</code></h3>
<p>В предыдущем разделе мы использовали оператор <code>:=</code> ради его побочного эффекта. Но, разумеется, это не всегда может быть желательно. Иногда мы хотели бы передать объект <code>data.table</code> функции и использовать оператор <code>:=</code>, но не хотели бы обновлять исходный объект. Мы можем достичь этого, используя функцию <code>copy()</code>.</p>
<p>Функция <code>copy()</code> создает <em>глубокую копию</em> исходного объекта, и поэтому любые последующие операции обновления по ссылке, выполняемые на скопированном объекте, не влияют на исходный объект.</p>
<p>Есть два конкретных случая, когда функция <code>copy()</code> имеет важное значение:</p>
<ol style="list-style-type: decimal">
<li>В отличие от ситуации, которую мы видели в предыдущем пункте, мы можем не хотеть, чтобы таблица <em>data.table</em>, передаваемая функции, изменялась <em>по ссылке</em>. В качестве примера давайте рассмотрим задачу из предыдущего раздела, за исключением того, что не хотим изменять <code>flights</code> по ссылке.</li>
</ol>
<p>Сперва удалим столбец <code>speed</code>, созданный в предыдущем разделе.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights[, speed :<span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]</code></pre></div>
<p>Теперь мы можем выполнить задачу следующим образом:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">foo &lt;-<span class="st"> </span>function(DT) {
  DT &lt;-<span class="st"> </span><span class="kw">copy</span>(DT)                             ## deep copy
  DT[, speed :<span class="er">=</span><span class="st"> </span>distance /<span class="st"> </span>(air_time/<span class="dv">60</span>)]    ## doesn&#39;t affect &#39;flights&#39;
  DT[, .(<span class="dt">max_speed =</span> <span class="kw">max</span>(speed)), by=month]
}
ans &lt;-<span class="st"> </span><span class="kw">foo</span>(flights)
<span class="kw">head</span>(flights)
<span class="co">#    year month day dep_time dep_delay arr_time arr_delay cancelled carrier tailnum flight origin</span>
<span class="co"># 1: 2014     1   1      914        14     1238        13         0      AA  N338AA      1    JFK</span>
<span class="co"># 2: 2014     1   1     1157        -3     1523        13         0      AA  N335AA      3    JFK</span>
<span class="co"># 3: 2014     1   1     1902         2     2224         9         0      AA  N327AA     21    JFK</span>
<span class="co"># 4: 2014     1   1      722        -8     1014       -26         0      AA  N3EHAA     29    LGA</span>
<span class="co"># 5: 2014     1   1     1347         2     1706         1         0      AA  N319AA    117    JFK</span>
<span class="co"># 6: 2014     1   1     1824         4     2145         0         0      AA  N3DEAA    119    EWR</span>
<span class="co">#    dest air_time distance hour min</span>
<span class="co"># 1:  LAX      359     2475    9  14</span>
<span class="co"># 2:  LAX      363     2475   11  57</span>
<span class="co"># 3:  LAX      351     2475   19   2</span>
<span class="co"># 4:  PBI      157     1035    7  22</span>
<span class="co"># 5:  LAX      350     2475   13  47</span>
<span class="co"># 6:  LAX      339     2454   18  24</span>
<span class="kw">head</span>(ans)
<span class="co">#    month max_speed</span>
<span class="co"># 1:     1  535.6425</span>
<span class="co"># 2:     2  535.6425</span>
<span class="co"># 3:     3  549.0756</span>
<span class="co"># 4:     4  585.6000</span>
<span class="co"># 5:     5  544.2857</span>
<span class="co"># 6:     6  608.5714</span></code></pre></div>
<ul>
<li><p>Использование функции <code>copy()</code> не обновляет по ссылке таблицу <em>data.table</em> <code>flights</code>. Эта таблица не содержит столбца <code>speed</code>.</p></li>
<li><p><code>ans</code> содержит максимальную скорость, соответствующую каждому месяцу.</p></li>
</ul>
<p>Однако мы могли еще улучшить эту функциональность, делая <em>поверхностное</em> копирование вместо <em>глубокого</em>. На самом деле, мы бы очень хотели <a href="https://github.com/Rdatatable/data.table/issues/617">обеспечить эту функциональность в <code>v1.9.8</code></a>. Мы коснемся этой темы еще раз в виньетке “data.table design”.</p>
<ol start="2" style="list-style-type: decimal">
<li>Когда мы сохраняем имена столбцов в переменной, например, <code>DT_n = names(DT)</code>, а затем <em>добавляем/обновляем/удаляем</em> столбцы <em>по ссылке</em>, это также изменит <code>DT_n</code>, если мы не выполним <code>copy(names(DT))</code>.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">DT =<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">x=</span><span class="dv">1</span>, <span class="dt">y=</span><span class="dv">2</span>)
DT_n =<span class="st"> </span><span class="kw">names</span>(DT)
DT_n
<span class="co"># [1] &quot;x&quot; &quot;y&quot;</span>

## add a new column by reference
DT[, z :<span class="er">=</span><span class="st"> </span><span class="dv">3</span>]

## DT_n also gets updated
DT_n
<span class="co"># [1] &quot;x&quot; &quot;y&quot; &quot;z&quot;</span>

## use `copy()`
DT_n =<span class="st"> </span><span class="kw">copy</span>(<span class="kw">names</span>(DT))
DT[, w :<span class="er">=</span><span class="st"> </span><span class="dv">4</span>]

## DT_n doesn&#39;t get updated
DT_n
<span class="co"># [1] &quot;x&quot; &quot;y&quot; &quot;z&quot;</span></code></pre></div>
</div>
</div>
<div id="ch3.4" class="section level2">
<h2><span class="header-section-number">3.6</span> Резюме</h2>
<div id="section-3.6.0.1" class="section level4">
<h4><span class="header-section-number">3.6.0.1</span> - Оператор <code id="ch3.4.1.1">:=</code></h4>
<ul>
<li><p>Используется для <em>добавления/обновления/удаления</em> столбцов <em>по ссылке</em>.</p></li>
<li><p>Мы также увидели, как использовать <code>:=</code> вместе с <code>i</code> и <code>by</code> таким же образом, как мы видели в виньетке “Введение в data.table”. Еще мы можем использовать <code>keyby</code>, цепочечные операции, передавать выражения в <code>by</code>. Синтаксис согласован.</p></li>
<li><p>Мы можем использовать оператор <code>:=</code> ради его побочного эффекта, или использовать <code>copy()</code>, чтобы не изменять исходный объект при обновлении по ссылке.</p></li>
</ul>
<p>Пока что мы увидели много всего, что может <code>j</code>, как это комбинировать с <code>by</code> , а также немного возможностей <code>i</code>. Давайте обратим наше внимание на <code>i</code> в следующей виньетке “Keys and fast binary search based subset” для выполнения <em>молниеносного создания поднаборов</em> при помощи <em>установки ключей</em> (<em>keying</em>) в <em>data.tables</em>.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="02_data.table_keys.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="04_data.table_reshaping.html" class="navigation navigation-next " aria-label="Next page""><i class="fa fa-angle-right"></i></a>

<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
